%% Copyright (c) 2022 Peter Morgan <peter.james.morgan@gmail.com>
%%
%% Licensed under the Apache License, Version 2.0 (the "License");
%% you may not use this file except in compliance with the License.
%% You may obtain a copy of the License at
%%
%% http://www.apache.org/licenses/LICENSE-2.0
%%
%% Unless required by applicable law or agreed to in writing, software
%% distributed under the License is distributed on an "AS IS" BASIS,
%% WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
%% See the License for the specific language governing permissions and
%% limitations under the License.


-module(jose_jwk_set_tests).


-include_lib("eunit/include/eunit.hrl").


read_file_test_() ->
    lists:map(

      t(fun
            (Filename) ->
                jose_jwk_set:read_file(Filename)
        end),

      [{#{<<"1">> =>
              #{crv => <<"P-256">>,
                kty => ec,
                x =>
                    <<48,160,66,76,210,28,41,68,131,138,45,117,201,43,55,231,
                      110,162,13,159,0,137,58,59,78,238,138,60,10,175,236,62>>,
                y =>
                    <<224,75,101,233,36,86,217,136,139,82,179,121,189,251,
                      213,30,232,105,239,31,15,198,91,102,89,105,91,108,206,
                      8,23,35>>},
          <<"2011-04-29">> =>
              #{e => <<1,0,1>>,
                kty => rsa,
                n =>
                    <<210,252,123,106,10,30,108,103,16,74,235,143,136,178,
                      87,102,155,77,246,121,221,173,9,155,92,74,108,217,168,
                      128,21,181,161,51,191,11,133,108,120,113,182,223,0,11,
                      85,79,206,179,194,237,81,43,182,143,20,92,110,132,52,
                      117,47,171,82,161,207,193,36,64,143,121,181,138,69,
                      120,193,100,40,133,87,137,247,162,73,227,132,203,45,
                      159,174,45,103,253,150,251,146,108,25,142,7,115,153,
                      253,200,21,192,175,9,125,222,90,173,239,244,77,231,14,
                      130,127,72,120,67,36,57,191,238,185,96,104,208,71,79,
                      197,13,109,144,191,58,152,223,175,16,64,200,156,2,214,
                      146,171,59,60,40,150,96,157,134,253,115,183,116,206,7,
                      64,100,124,238,234,163,16,189,18,249,133,168,235,159,
                      89,253,212,38,206,165,178,18,15,79,42,52,188,171,118,
                      75,126,108,84,214,132,2,56,188,196,5,135,165,158,102,
                      237,31,51,137,69,119,99,92,71,10,247,92,249,44,32,209,
                      218,67,225,191,196,25,226,34,166,240,208,187,53,140,
                      94,56,249,203,5,10,234,254,144,72,20,241,172,26,164,
                      156,202,158,160,202,131>>}},
        "test/jwk/a1-example-public-keys.json"},

      {#{<<"1">> =>
             #{crv => <<"P-256">>,
               d =>
                   <<243,189,12,7,168,31,185,50,120,30,213,39,82,246,12,200,
                     154,107,229,229,25,52,254,1,147,141,219,85,216,247,120,1>>,
               kty => ec,
               x =>
                   <<48,160,66,76,210,28,41,68,131,138,45,117,201,43,55,231,
                     110,162,13,159,0,137,58,59,78,238,138,60,10,175,236,62>>,
               y =>
                   <<224,75,101,233,36,86,217,136,139,82,179,121,189,251,
                     213,30,232,105,239,31,15,198,91,102,89,105,91,108,206,
                     8,23,35>>},
         <<"2011-04-29">> =>
             #{d =>
                   <<95,135,19,181,226,88,254,9,248,21,131,236,92,31,43,117,
                     120,177,230,252,44,131,81,75,55,145,55,17,161,186,68,
                     154,21,31,225,203,44,160,253,51,183,113,230,138,59,25,
                     68,100,157,200,103,173,28,30,82,64,187,133,62,95,36,179,
                     52,89,177,64,40,210,214,99,107,239,236,30,141,169,116,
                     179,82,252,83,211,246,18,126,168,163,194,157,209,79,57,
                     65,104,44,86,167,135,104,22,78,77,218,143,6,203,249,199,
                     52,170,232,0,50,36,39,142,169,69,74,33,177,124,176,109,
                     23,128,117,134,140,192,91,61,182,255,29,253,195,213,99,
                     120,180,237,173,237,240,195,122,76,220,38,209,212,154,
                     194,111,111,227,181,34,10,93,210,147,150,98,27,188,104,
                     140,242,238,226,198,224,213,77,163,199,130,1,76,208,115,
                     157,178,82,204,81,202,235,168,211,241,184,36,186,171,36,
                     208,104,236,144,50,100,215,214,120,171,8,240,110,201,
                     231,226,61,150,6,40,183,68,191,148,179,105,70,86,70,60,
                     126,65,115,153,237,115,208,118,200,145,252,244,99,169,
                     170,156,230,45,169,205,23,226,55,220,42,128,2,241>>,
               dp =>
                   <<27,139,15,94,71,58,97,175,114,242,130,86,247,242,11,143,
                     140,110,166,155,180,151,56,191,31,181,83,145,47,49,143,
                     148,157,95,119,40,19,74,34,153,140,49,34,45,158,153,48,
                     46,123,69,14,107,151,105,128,81,178,4,158,28,242,212,54,
                     84,94,52,217,116,110,128,160,211,63,198,164,98,17,104,
                     230,208,0,239,180,30,252,217,173,185,134,92,220,45,230,
                     220,141,184,27,97,175,71,155,18,15,21,50,0,221,179,171,
                     194,223,159,209,20,154,206,171,99,115,155,241,135,162,
                     42,68,226,6,61>>,
               dq =>
                   <<179,217,64,31,215,224,128,27,40,21,31,14,105,205,145,
                     252,77,160,195,111,54,173,61,164,24,224,33,188,137,101,
                     17,49,53,121,250,192,234,27,148,82,243,31,5,195,41,159,
                     201,106,121,110,175,207,57,216,99,148,146,64,94,233,49,
                     208,191,106,2,55,156,111,8,110,157,65,81,189,9,82,42,
                     218,68,218,148,124,184,92,65,191,221,244,97,120,14,30,
                     222,239,133,155,70,202,27,70,137,238,141,54,13,215,16,
                     154,63,164,206,235,88,239,90,181,254,47,95,45,197,124,
                     56,247,132,63,114,9>>,
               e => <<1,0,1>>,
               kty => rsa,
               n =>
                   <<210,252,123,106,10,30,108,103,16,74,235,143,136,178,87,
                     102,155,77,246,121,221,173,9,155,92,74,108,217,168,128,
                     21,181,161,51,191,11,133,108,120,113,182,223,0,11,85,79,
                     206,179,194,237,81,43,182,143,20,92,110,132,52,117,47,
                     171,82,161,207,193,36,64,143,121,181,138,69,120,193,100,
                     40,133,87,137,247,162,73,227,132,203,45,159,174,45,103,
                     253,150,251,146,108,25,142,7,115,153,253,200,21,192,175,
                     9,125,222,90,173,239,244,77,231,14,130,127,72,120,67,36,
                     57,191,238,185,96,104,208,71,79,197,13,109,144,191,58,
                     152,223,175,16,64,200,156,2,214,146,171,59,60,40,150,96,
                     157,134,253,115,183,116,206,7,64,100,124,238,234,163,16,
                     189,18,249,133,168,235,159,89,253,212,38,206,165,178,18,
                     15,79,42,52,188,171,118,75,126,108,84,214,132,2,56,188,
                     196,5,135,165,158,102,237,31,51,137,69,119,99,92,71,10,
                     247,92,249,44,32,209,218,67,225,191,196,25,226,34,166,
                     240,208,187,53,140,94,56,249,203,5,10,234,254,144,72,20,
                     241,172,26,164,156,202,158,160,202,131>>,
               p =>
                   <<243,120,190,236,139,204,25,122,12,92,43,36,191,189,211,
                     42,191,58,223,177,98,59,182,118,239,59,252,162,62,169,
                     109,101,16,200,179,208,5,12,109,61,89,240,15,109,17,251,
                     173,30,76,57,131,218,232,231,50,222,79,162,163,43,155,
                     196,95,152,216,85,88,59,99,140,201,130,50,51,169,73,120,
                     156,20,120,251,92,235,149,33,132,50,169,85,165,88,72,
                     122,116,221,250,25,86,88,147,221,205,240,23,61,189,142,
                     53,199,47,1,245,28,243,56,101,80,205,123,205,18,249,251,
                     59,73,213,109,251>>,
               q =>
                   <<221,215,206,71,215,46,98,175,180,75,233,164,20,188,224,
                     34,216,12,17,241,115,7,106,183,133,103,161,50,225,180,
                     160,43,170,157,189,239,161,178,242,186,106,163,85,148,
                     14,213,210,43,119,8,19,156,39,105,99,48,92,57,245,185,
                     175,126,244,0,85,227,137,103,237,252,209,132,138,139,
                     232,158,44,225,42,154,61,85,84,187,241,60,197,131,25,8,
                     118,183,156,69,236,236,103,237,100,97,223,236,214,160,
                     219,198,217,3,18,7,192,33,48,6,244,181,39,0,59,167,226,
                     242,28,111,172,158,151,25>>,
               qi =>
                   <<27,35,63,167,162,107,95,36,162,207,91,104,22,2,155,89,
                     95,137,116,141,227,67,140,169,187,218,219,49,108,119,
                     173,2,65,126,107,116,22,134,51,129,66,25,17,81,68,112,
                     234,176,122,100,77,243,92,232,12,6,154,248,25,52,41,
                     99,70,14,50,71,100,55,67,152,88,86,220,3,123,148,143,
                     169,187,25,63,152,118,70,39,93,107,199,36,124,59,158,
                     87,45,39,183,72,249,145,124,172,25,35,172,148,219,134,
                     113,189,2,133,96,139,93,149,213,10,27,51,186,33,174,
                     179,76,168,64,85,21>>}},
       "test/jwk/a2-example-private-keys.json"}]).


t(F) ->
    fun
        ({Expected, Input} = Test) ->
            {nm(Test), ?_assertEqual(Expected, F(Input))}
    end.


nm(Test) ->
    iolist_to_binary(io_lib:fwrite("~p", [Test])).
